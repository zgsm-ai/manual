#!/bin/sh

# Pre-push hook to check for Chinese characters in docs folder
# å®‰è£…è¯´æ˜ï¼š
# 1. ç¡®ä¿æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™ï¼šchmod +x .git/hooks/pre-push
# 2. æˆ–è€…å°†æ­¤æ–‡ä»¶å¤åˆ¶åˆ° .git/hooks/pre-push

echo "ğŸ” æ£€æŸ¥docsæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦..."

# è·å–å³å°†æ¨é€çš„æäº¤
remote="$1"
url="$2"

z40=0000000000000000000000000000000000000000

while read local_ref local_sha remote_ref remote_sha
do
    if [ "$local_sha" != $z40 ]
    then
        # è·å–æ‰€æœ‰å°†è¦æ¨é€çš„æäº¤ä¸­ä¿®æ”¹çš„docsæ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶
        changed_files=$(git diff --name-only $remote_sha..$local_sha -- docs/** 2>/dev/null | grep -E '\.(md|json)$')
        
        if [ -n "$changed_files" ]; then
            echo "æ£€æµ‹åˆ°ä»¥ä¸‹docsæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶å˜æ›´ï¼š"
            echo "$changed_files"
            echo ""
            
            # æ£€æŸ¥ä¸­æ–‡å†…å®¹
            has_chinese=false
            
            for file in $changed_files; do
                # è½¬æ¢è·¯å¾„æ ¼å¼ï¼ˆWindowså…¼å®¹æ€§ï¼‰
                file=$(echo "$file" | sed 's|\\|/|g')
                
                if [ -f "$file" ]; then
                    echo "æ­£åœ¨æ£€æŸ¥æ–‡ä»¶: $file"
                    
                    # ä½¿ç”¨æ›´å…¼å®¹çš„æ–¹å¼æ£€æŸ¥ä¸­æ–‡å­—ç¬¦
                    if LC_ALL=C grep -q '[ä¸€-é¾¯]' "$file" 2>/dev/null; then
                        echo "âŒ æ–‡ä»¶ $file åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼š"
                        
                        # æ˜¾ç¤ºåŒ…å«ä¸­æ–‡çš„è¡Œ
                        LC_ALL=C grep -n '[ä¸€-é¾¯]' "$file" | while IFS= read -r line; do
                            line_num=$(echo "$line" | cut -d: -f1)
                            content=$(echo "$line" | cut -d: -f2-)
                            echo "  è¡Œ $line_num: $content"
                        done
                        
                        has_chinese=true
                    else
                        echo "âœ… æ–‡ä»¶ $file æ£€æŸ¥é€šè¿‡"
                    fi
                else
                    echo "âš ï¸ æ–‡ä»¶ $file ä¸å­˜åœ¨ï¼Œè·³è¿‡æ£€æŸ¥"
                fi
            done
            
            if [ "$has_chinese" = true ]; then
                echo ""
                echo "ğŸš¨ å‘ç°ä¸­æ–‡å­—ç¬¦ï¼docsæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ä¸åº”åŒ…å«ä¸­æ–‡å†…å®¹ã€‚"
                echo "è¯·å°†ä¸­æ–‡å†…å®¹ç§»è‡³ i18n/zh/docusaurus-plugin-content-docs/current/ ç›®å½•ä¸‹å¯¹åº”çš„æ–‡ä»¶ä¸­ã€‚"
                echo ""
                echo "æ¨é€è¢«é˜»æ­¢ã€‚ä¿®å¤é—®é¢˜åå†æ¬¡å°è¯•æ¨é€ã€‚"
                exit 1
            else
                echo "âœ… æ‰€æœ‰æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼Œæœªå‘ç°ä¸­æ–‡å­—ç¬¦ã€‚"
            fi
        else
            echo "æœªæ£€æµ‹åˆ°docsæ–‡ä»¶å¤¹ä¸­çš„.mdæˆ–.jsonæ–‡ä»¶å˜æ›´ã€‚"
        fi
    fi
done

echo "ğŸ‰ é¢„æ¨é€æ£€æŸ¥å®Œæˆï¼"
exit 0